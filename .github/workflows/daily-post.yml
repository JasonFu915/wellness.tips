name: Daily Health Tip Generator

on:
  schedule:
    - cron: '15 0 * * *'  # Runs daily at 00:15 UTC (08:15 Beijing Time) to avoid congestion
  workflow_dispatch:      # Allows manual trigger for testing

jobs:
  generate-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Permission to push changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Debug Secret Availability
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          if [ -z "$DASHSCOPE_API_KEY" ]; then
            echo "::error::Secret DASHSCOPE_API_KEY is empty or not accessible!"
            exit 1
          else
            echo "Secret DASHSCOPE_API_KEY is present (length: ${#DASHSCOPE_API_KEY})"
          fi

      - name: Generate Daily Tip
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          python scripts/generate_daily_tip.py

      - name: Commit and Push Changes
        run: |
          git config --global user.name 'HealthTipBot'
          git config --global user.email 'bot@healthtips.ai'
          
          # Check if there are any changes
          if [[ -n $(git status -s) ]]; then
            git add content/
            git commit -m "Auto-generated daily health tip"
            git pull --rebase
            git push
          else
            echo "No changes to commit"
          fi

      - name: Trigger Vercel Deployment
        if: success()
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -n "$VERCEL_DEPLOY_HOOK" ]; then
            echo "Triggering Vercel deployment..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$VERCEL_DEPLOY_HOOK")
            echo "Vercel deploy hook HTTP status: $STATUS"
            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
              echo "::error::Vercel deploy hook failed with status $STATUS. Check hook URL and project settings."
              exit 1
            fi
          else
            echo "No VERCEL_DEPLOY_HOOK secret found. Skipping Vercel trigger."
            echo "To enable auto-deploy for bot commits, add VERCEL_DEPLOY_HOOK in GitHub Secrets."
          fi
